#!/usr/bin/env bash
#vim:filetype=sh:shiftwidth=2:softtabstop=2:expandtab:foldmethod=marker:foldmarker=###{{{,###}}}
#shellcheck disable=2016,2034,2059,2154,2249,2310,2312

set -Eeo pipefail
IFS=$'\n\t'

#######################################
# TODO
#######################################
# TODO: When you uninstall a package and return back to yayfzf, the package still shows as installed. Need to refresh.

#######################################
# Script metadata
#######################################
readonly SCRIPT_NAME="${0##*/}"
readonly SCRIPT_DESCRIPTION="Fullscreen interactive AUR / repo package manager using yay + fzf"
readonly SCRIPT_AUTHOR="ConnerWill"
readonly SCRIPT_AUTHOR_URL="https://github.com/ConnerWill"
readonly VERSION="2.0.11"

#######################################
# Config locations (precedence order)
#######################################
readonly XDG_CONFIG_DIR="${XDG_CONFIG_HOME:-${HOME}/.config}/yayfzf"
readonly CONFIG_PATHS=(
  "${XDG_CONFIG_DIR}/yayfzf.conf"
  "${HOME}/.yayfzf.conf"
)

#######################################
# Defaults (override via config)
#######################################
THEME="${THEME:-default}"
SORT_BY="${SORT_BY:-popularity}"
PREVIEW_WINDOW="${PREVIEW_WINDOW:-right:60%:wrap}"
LAYOUT="${LAYOUT:-reverse}"
BORDER="${BORDER:-rounded}"
YAYFZF_PROMPT="${YAYFZF_PROMPT:-${SCRIPT_NAME}> }"
ENABLE_PREVIEW=${ENABLE_PREVIEW:-true}
VERBOSE=${VERBOSE:-false}
CTRL_C_CLOSE=${CTRL_C_CLOSE:-true}
YAYFZF_PAGER="${YAYFZF_PAGER:-${PAGER:-less}}"
NO_COLOR=${NO_COLOR:-false}

#######################################
# Built-in themes
#######################################
declare -A BUILTIN_THEMES

BUILTIN_THEMES[default]="
fg:#c0caf5
bg:#1a1b26
hl:#7aa2f7
fg+:#c0caf5
bg+:#24283b
hl+:#7dcfff
info:#7aa2f7
prompt:#7dcfff
pointer:#7dcfff
marker:#9ece6a
spinner:#9ece6a
header:#9ece6a
"

BUILTIN_THEMES[light]="
fg:#000000
bg:#ffffff
hl:#005faf
fg+:#000000
bg+:#eaeaea
hl+:#005faf
info:#5f5f5f
prompt:#005faf
pointer:#005faf
marker:#008700
spinner:#008700
header:#008700
"

BUILTIN_THEMES[tokyo-night]="
fg:#C0CAF5
bg:#1A1B26
hl:#FF9E64
fg+:#c0caf5
bg+:#24283b
hl+:#e0af68
info:#7aa2f7
prompt:#bb9af7
pointer:#e0af68
marker:#9ece6a
spinner:#7dcfff
header:#9ece6a
"

BUILTIN_THEMES[neon]="
fg:#E0D0FF
bg:#1A1B26
hl:#FF66FF
fg+:#FFFFFF
bg+:#24283b
hl+:#FF99FF
info:#00FFFF
prompt:#D0A0FF
pointer:#FF00FF
marker:#00FFFF
spinner:#00FFFF
header:#FF99FF
"

#######################################
# Text colors
#######################################
if [[ -n "${NO_COLOR}" && "${NO_COLOR}" != true ]]; then
  export C_RESET='\x1B[0m'
  export C_BOLD='\x1B[1m'
  export C_ITALIC='\x1B[3m'
  export C_UNDERLINE='\x1B[4m'
  export C_BLACK='\x1B[38;5;0m'
  export C_GRAY='\x1B[38;5;245m'
  export C_DARKGRAY='\x1B[38;5;8m'
  export C_WHITE='\x1B[38;5;15m'
  export C_RED='\x1B[38;5;196m'
  export C_GREEN='\x1B[38;5;46m'
  export C_YELLOW='\x1B[38;5;190m'
  export C_BLUE='\x1B[38;5;33m'
  export C_PURPLE='\x1B[38;5;93m'
  export C_MAGENTA='\x1B[38;5;201m'
  export C_CYAN='\x1B[38;5;87m'
  export C_BG_BLACK='\x1B[48;5;0m'
  export C_BG_GRAY='\x1B[48;5;245m'
  export C_BG_DARKGRAY='\x1B[48;5;8m'
  export C_BG_WHITE='\x1B[48;5;15m'
  export C_BG_RED='\x1B[48;5;196m'
  export C_BG_GREEN='\x1B[48;5;46m'
  export C_BG_YELLOW='\x1B[48;5;190m'
  export C_BG_BLUE='\x1B[48;5;33m'
  export C_BG_PURPLE='\x1B[48;5;93m'
  export C_BG_MAGENTA='\x1B[48;5;201m'
  export C_BG_CYAN='\x1B[48;5;87m'
  export C_SAVE_TITLE='\x1B[22;0t'
  export C_RESTORE_TITLE='\x1B[23;0t'
  export COLOR_WHEN='always'
else
  export COLOR_WHEN='never'
fi

#######################################
# Load config
#######################################
load_config() {
  local cfg
  verbose "Searching for config files ..."
  for cfg in "${CONFIG_PATHS[@]}"; do
    if [[ -f "${cfg}" ]]; then
      verbose "Using config file: '${cfg}' ..."
      # shellcheck disable=SC1090
      source "${cfg}"
      return
    fi
  done
}

#######################################
# Theme resolution
#######################################
resolve_theme() {
  verbose "Loading theme ..."
  # User-defined colors override everything
  if [[ -n "${FZF_COLORS:-}" ]]; then
    return
  fi

  if [[ -n "${BUILTIN_THEMES[${THEME}]:-}" ]]; then
    FZF_COLORS="${BUILTIN_THEMES[${THEME}]}"
    return
  fi

  warn "Unknown theme: '${THEME}', reverting to 'default' theme"
  FZF_COLORS="${BUILTIN_THEMES[default]}"
}

#######################################
# Utilities
#######################################
die() {
  local msg="${1:-Unknown error}"
  printf '%b%s%b%s%b\n' "${C_BG_RED}${C_WHITE}${C_BOLD}" "  ERROR  " "${C_RESET}${C_RED}" " ${msg}" "${C_RESET}" >&2
  exit 1
}

warn() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  printf '%b%s%b%s%b\n' "${C_BG_YELLOW}${C_BLACK}${C_BOLD}" " WARNING " "${C_RESET}${C_YELLOW}" " ${msg}" "${C_RESET}" >&2
}

info() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  printf '%b%s%b%s%b\n' "${C_BG_BLUE}${C_WHITE}${C_BOLD}" "   INFO  " "${C_RESET}${C_BLUE}" " ${msg}" "${C_RESET}"
}

verbose() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  if [[ -n "${VERBOSE}" && "${VERBOSE}" != false ]]; then
    printf '%b%s%b%s%b\n' "${C_BG_PURPLE}${C_WHITE}${C_BOLD}" " VERBOSE " "${C_RESET}${C_PURPLE}" " ${msg}" "${C_RESET}"
  fi
}

success() {
  local msg="${1:-}"
  [[ -z "${msg}" ]] && return
  printf '%b%s%b%s%b\n' "${C_BG_GREEN}${C_BLACK}${C_BOLD}" " SUCCESS " "${C_RESET}${C_GREEN}" " ${msg}" "${C_RESET}"
}

require_cmd() {
  local cmd
  for cmd in "${@}"; do
    verbose "Checking dependency: ${cmd} ..."
    if command -v "${cmd}" >/dev/null 2>&1; then
      verbose "Found '${cmd}' in PATH ..."
    else
      die "Could not find '${cmd}' in PATH. Make sure it is installed and is in your PATH"
    fi
  done
}

confirm() {
  local prompt="${1:-Are you sure?}"
  local response
  printf '%b%s%b ' "${C_BG_CYAN}${C_BLACK}${C_BOLD}" " CONFIRM " "${C_RESET}"
  printf "${C_BOLD}${C_YELLOW}%s ${C_RESET}${C_BOLD}${C_WHITE}[${C_GREEN}y${C_WHITE}/${C_RED}N${C_WHITE}]: ${C_RESET}" "${prompt}"
  read -r response
  [[ "${response}" =~ ^[Yy]$ ]]
}

draw_line() {
  local WORD LINE
  LINE=''
  COLS="$(tput cols)"
  (( COLS <= 0 )) && COLS="${COLUMNS:-80}"
  for WORD in "${@:-─}"; do
    #shellcheck disable=SC2183
    printf -v LINE '%*s' "${COLS}"
    LINE="${LINE// /${WORD}}"
    echo "${LINE:0:${COLS}}"
  done
}

#######################################
# Help / version
#######################################
show_help() {
  printf "$(cat <<HELPMENU
${C_BLUE}${C_BOLD}NAME${C_RESET}

  ${C_GREEN}${SCRIPT_NAME}${C_RESET}


${C_BLUE}${C_BOLD}DESCRIPTION${C_RESET}

  ${C_WHITE}${SCRIPT_DESCRIPTION}${C_RESET}


${C_BLUE}${C_BOLD}USAGE${C_RESET}

  ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_ITALIC}${C_YELLOW}[options]${C_RESET} ${C_ITALIC}${C_PURPLE}[search query]${C_RESET}


${C_BLUE}${C_BOLD}OPTIONS${C_RESET}

  ${C_YELLOW}-k${C_RESET}, ${C_YELLOW}--keybindings${C_RESET}
      ${C_WHITE}Show keybindings${C_RESET}

  ${C_YELLOW}-i${C_RESET}, ${C_YELLOW}--init-config${C_RESET}
      ${C_WHITE}Install example configuration file${C_RESET}

  ${C_YELLOW}-s${C_RESET}, ${C_YELLOW}--show-config${C_RESET}
      ${C_WHITE}Show example configuration file content${C_RESET}

  ${C_YELLOW}-v${C_RESET}, ${C_YELLOW}--verbose${C_RESET}
      ${C_WHITE}Show verbose output${C_RESET}

  ${C_YELLOW}-h${C_RESET}
      ${C_WHITE}Show help${C_RESET}

  ${C_YELLOW}--help${C_RESET}
      ${C_WHITE}Show full help${C_RESET}

  ${C_YELLOW}--help-man${C_RESET}
      ${C_WHITE}Show man page${C_RESET}

  ${C_YELLOW}-V${C_RESET}, ${C_YELLOW}--version${C_RESET}
      ${C_WHITE}Show version${C_RESET}


HELPMENU
  )\n\n"
}

show_examples() {
  printf "$(cat <<EXAMPLESMENU

${C_BLUE}${C_BOLD}EXAMPLES${C_RESET}

  ${C_WHITE}Start ${SCRIPT_NAME} with no options or query${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET}


  ${C_WHITE}Start ${SCRIPT_NAME} with an initial search query of ${C_RESET}${C_PURPLE}'rclone'${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_PURPLE}'rclone'${C_RESET}


  ${C_WHITE}Install ${SCRIPT_NAME} configuration file${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_YELLOW}--init-config${C_RESET}


  ${C_WHITE}Show ${SCRIPT_NAME} keybindings${C_RESET}

    ${C_GRAY}\$${C_RESET} ${C_GREEN}${SCRIPT_NAME}${C_RESET} ${C_YELLOW}--keybindings${C_RESET}


EXAMPLESMENU
  )\n\n\n"
}

show_keybindings() {
  printf "$(cat <<KEYBINDINGSMENU
${C_BLUE}${C_BOLD}KEYBINDINGS${C_RESET}

  ${C_CYAN}NAVIGATION${C_RESET}

    ↑/↓                   - Move up/down
    PGUP                  - Move up one page
    PGDN                  - Move down one page
    HOME                  - Move to first
    END                   - Move to last

  ${C_CYAN}SELECT${C_RESET}

    TAB / Shift-TAB       - Select / Unselect
    CTRL-a                - Select all
    CTRL-d                - Deselect all

  ${C_CYAN}ACTIONS${C_RESET}

    ENTER                 - Perform action on selection
    CTRL-i                - Install selected packages
    CTRL-r                - Uninstall package
    CTRL-u                - Update all packages

  ${C_CYAN}QUERY${C_RESET}

    CTRL-l                - Clear query
    CTRL-Backspace        - Clear query

  ${C_CYAN}LAYOUT${C_RESET}

    CTRL-/                - Change layout
    CTRL-v                - Toggle preview

  ${C_CYAN}HELP${C_RESET}

    ?                     - Show keybindings

  ${C_CYAN}EXIT${C_RESET}

    CTRL-c                - Exit
    CTRL-w                - Exit
    ESC                   - Exit


KEYBINDINGSMENU
  )\n\n\n"
}

show_config_file_paths() {
  printf "$(cat <<CONFIGFILESMENU
${C_BLUE}${C_BOLD}CONFIGURATION FILES${C_RESET} ${C_ITALIC}${C_GRAY}(in order)${C_RESET}

$(printf '  %s\n' "${CONFIG_PATHS[@]}")


CONFIGFILESMENU
  )\n\n\n"
}

show_version() {
  printf '%b%s%b %b%s%b\n' "${C_GREEN}" "${SCRIPT_NAME}" "${C_RESET}" "${C_YELLOW}" "${VERSION}" "${C_RESET}"
}

show_author() {
  printf '%b%s%b %b%s%b\n' "${C_GREEN}" "${SCRIPT_AUTHOR}" "${C_RESET}" "${C_YELLOW}" "${SCRIPT_AUTHOR_URL}" "${C_RESET}"
}

show_help_man() {
  require_cmd man
  man "${SCRIPT_NAME}"
}

show_help_full() {
  draw_line "─"
  show_help
  show_examples
  show_keybindings
  show_config_file_paths
  show_version
  show_author
  draw_line "─"
}

#######################################
# Example config
#######################################

example_config() {
  cat <<EOF
# yayfzf configuration file (example)
# Override defaults here

# Theme: default, light, tokyo-night, neon
THEME="${THEME:-neon}"

# Package sort order: popularity, votes, last_updated
SORT_BY="${SORT_BY:-popularity}"

# Preview window options for fzf
PREVIEW_WINDOW="${PREVIEW_WINDOW:-right:60%:wrap}"

# Layout: default, reverse
LAYOUT="${LAYOUT:-reverse}"

# Border style: default, rounded
BORDER="${BORDER:-rounded}"

# Prompt for fzf
YAYFZF_PROMPT="${YAYFZF_PROMPT:-${SCRIPT_NAME}> }"

# Enable preview window
ENABLE_PREVIEW=${ENABLE_PREVIEW:-true}

# Verbose output
VERBOSE=${VERBOSE:-false}

# Pager (less, bat, etc.)
YAYFZF_PAGER="${PAGER:-less}"

# Close yayfzf with 'ctrl-c' keypress
CTRL_C_CLOSE=${CTRL_C_CLOSE:-true}

# Disable color output
NO_COLOR=${NO_COLOR:-false}

#vim:filetype=conf:shiftwidth=2:softtabstop=2:expandtab
EOF
}


install_example_config() {
  local cfg_file="${XDG_CONFIG_DIR}/yayfzf.conf"

  mkdir -p "$(dirname "${cfg_file}")"
  if [[ -f "${cfg_file}" ]]; then
    warn "Configuration file already exists: '${cfg_file}', skipping creation."
    return
  fi

  example_config > "${cfg_file}"
  success "Created configuration file: '${cfg_file}'"
}

show_example_config() {
  local cfg_file="${XDG_CONFIG_DIR}/yayfzf.conf"
  if [[ -f "${cfg_file}" ]]; then
    "${YAYFZF_PAGER}" "${cfg_file}"
  else
    example_config
  fi
  printf "\n\n# Configuration file locations:\n"
  printf '#\t%s\n' "${CONFIG_PATHS[@]}"
}

#######################################
# Command line argument parsing
#######################################
SEARCH_QUERY=""
CONFIG_INIT=false
if [[ -n "${VERBOSE}" && "${VERBOSE}" != false ]]; then
  export VERBOSE
fi

while [[ $# -gt 0 ]]; do
  case "${1}" in
    -k|--key*)      show_keybindings;                           exit 0 ;;
    -i|--init-c*)   CONFIG_INIT=true;                           shift  ;;
    -s|--show-c*)   show_example_config;                        exit 0 ;;
    -v|--verb*)     export VERBOSE=true;                        shift  ;;
    -h)             show_help;                                  exit 0 ;;
    --help)         show_help_full;                             exit 0 ;;
    --help-man)     show_help_man;                              exit 0 ;;
    -V|--vers*)     show_version;                               exit 0 ;;
    -*)             die "Unknown option: '${1}'. See help for options" ;;
    *)              SEARCH_QUERY+="${SEARCH_QUERY:+ }${1}";     shift  ;;
  esac
done

#######################################
# Init
#######################################
load_config
resolve_theme
require_cmd yay fzf

if [[ "${CONFIG_INIT}" == true ]]; then
  install_example_config
  exit 0
fi

#######################################
# Build fzf options (fullscreen only)
#######################################
# TODO: Add more options
# --border-label="┨${SCRIPT_NAME}┠"
# --preview-label="╣${SCRIPT_NAME}╠"
# --border-label-pos=-3
FZF_OPTS=(
  --ansi
  --bind="?:preview(echo '$(show_keybindings)')"
  --bind='ctrl-w:abort'
  --bind='end:last'
  --bind='esc:abort'
  --bind='home:first'
  --bind='pgdn:page-down'
  --bind='pgup:page-up'
  --border="${BORDER}"
  --color="$(printf '%s' "${FZF_COLORS}" | tr '\n' ',' | sed 's/,$//')"
  --delimiter=' '
  --ellipsis='⣿'
  --header='Press ? for keybindings'
  --layout="${LAYOUT}"
  --multi
  --info=inline
  --prompt="${YAYFZF_PROMPT}"
  --tiebreak=begin
)

if [[ -n "${ENABLE_PREVIEW}" && "${ENABLE_PREVIEW}" != false ]]; then
  FZF_OPTS+=( --preview-window="${PREVIEW_WINDOW}" )
fi

readonly FZF_OPTS

# NOTE: These bind options are not for the main menu. If you want to add bindings to main menu,
# Please configure bindings in 'FZF_OPTS'
FZF_BIND_OPTS=(
  --bind='ctrl-/:change-preview-window(up,border-rounded|up,40%,border-rounded|left,border-rounded|left,border-rounded,40%|down,border-rounded|down,40%,border-rounded|down,10%,border-rounded|hidden|right,40%,border-rounded|right,70%,border-rounded|right,90%,border-rounded)'
  --bind='ctrl-a:select-all'
  --bind='ctrl-bspace:clear-query'
  --bind='ctrl-d:deselect-all'
  --bind='ctrl-l:clear-query+clear-screen+clear-selection'
  --bind='ctrl-v:toggle-preview'
  --bind='ctrl-i:execute:yay -S $(echo {+} | cut -d" " -f1)'
  --bind='ctrl-r:execute:yay -R $(echo {1} | cut -d"/" -f2)'
  --bind='ctrl-u:execute:yay -Syu'
)

readonly FZF_BIND_OPTS

#######################################
# Core actions
#######################################
search_packages() {
  export SORT_BY
  local sl_cmd="yay --color ${COLOR_WHEN} -Sl | awk '{status = (tolower(\$4) == \"[installed]\") ? \" [Installed]\" : \"\"; print \$1\"/\"\$2 status}'"
  local ss_cmd="yay --color ${COLOR_WHEN} -Ss --sortby \"${SORT_BY}\" --topdown {q} | awk '/^[^[:space:]]/ { status = (\$0 ~ /\\(Installed\\)/) ? \" [Installed]\" : \"\"; print \$1 status }'"
  local reload_cmd="if [ -z {q} ]; then ${sl_cmd}; else ${ss_cmd}; fi"

  fzf "${FZF_OPTS[@]}" "${FZF_BIND_OPTS[@]}" \
    --query="${SEARCH_QUERY}" \
    --disabled \
    --bind "start:reload(${reload_cmd})" \
    --bind "change:reload(${reload_cmd})" \
    --preview 'yay -Si {1}' |
    awk '{ print $1 }'
}

install_packages() {
  local pkgs pkgs_arr

  pkgs="$(search_packages || true)"
  [[ -z "${pkgs}" ]] && verbose "No packages selected for installation." && return

  mapfile -t pkgs_arr <<< "${pkgs}"

  info "Installing packages: ${pkgs_arr[*]} ..."
  if yay -S --needed "${pkgs_arr[@]}"; then
    success "Installation complete."
  else
    die "Installation failed for: ${pkgs_arr[*]}"
  fi
}

remove_packages() {
  local pkgs pkgs_arr

  # Gather list of selected packages
  pkgs="$(yay -Qq | fzf "${FZF_OPTS[@]}" "${FZF_BIND_OPTS[@]}" --preview 'yay -Qi {}' || true)"
  [[ -z "${pkgs}" ]] && verbose "No packages selected for removal." && return

  mapfile -t pkgs_arr <<< "${pkgs}"

  # Confirm removal
  if ! confirm "Remove packages: ${pkgs_arr[*]} ?"; then
    info "Removal cancelled."
    return
  fi

  # Remove packages
  info "Removing packages: ${pkgs_arr[*]} ..."
  if yay -Rns "${pkgs_arr[@]}"; then
    success "Removal complete."
  else
    die "Removal failed for: ${pkgs_arr[*]}"
  fi
}

update_system() {
  if ! confirm "Update entire system?"; then
    info "Update cancelled."
    return
  fi

  info "Starting system update (syncing all packages) ..."
  if yay -Syu; then
    success "System update completed successfully."
  else
    die "System update failed. Check above output for errors."
  fi
}

#######################################
# Main menu
#######################################
main_menu() {
  printf '%s\n'        \
    "Install packages" \
    "Remove packages"  \
    "Update system"    \
    "Install config"   \
    "Show config"      \
    "Help"             \
    "Exit" |
    fzf "${FZF_OPTS[@]}"
}

#######################################
# Main loop
#######################################
main() {
  while true; do
    local choice
    choice="$(main_menu || true)"
    if [[ -n "${CTRL_C_CLOSE}" && "${CTRL_C_CLOSE}" != true ]]; then
      [[ -z "${choice}" ]] && continue
    fi

    case "${choice}" in
      "Install packages") install_packages               ;;
      "Remove packages")  remove_packages                ;;
      "Update system")    update_system                  ;;
      "Install config")   install_example_config; exit 0 ;;
      "Show config")      show_example_config ;   exit 0 ;;
      "Help")             show_help_full ;        exit 0 ;;
      "Exit"|"" )         exit 0                         ;;
    esac
  done
}

main
